<!DOCTYPE html>
<html lang="en">
<!-- Previous head content remains the same -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Viewer & Chatbot</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex flex-col h-screen bg-gray-100">
    <!-- Previous HTML content remains the same until the script -->

    <script type="module">
        import * as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.module.min.js';
        import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three/examples/jsm/loaders/GLTFLoader.js';
        import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three/examples/jsm/controls/OrbitControls.js';

        // Debug information
        console.log('Starting 3D viewer setup...');

        // Setup scene
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        const viewerDiv = document.getElementById('viewer');
        
        renderer.setSize(viewerDiv.clientWidth, viewerDiv.clientHeight);
        viewerDiv.appendChild(renderer.domElement);

        // Add lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 5, 5);
        scene.add(directionalLight);

        // Add controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // Loading manager for better error handling
        const loadingManager = new THREE.LoadingManager();
        loadingManager.onError = function(url) {
            console.error('Error loading:', url);
            document.getElementById('loading').innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                    Error loading 3D model. Please check console for details.
                </div>
            `;
        };

        loadingManager.onProgress = function(url, itemsLoaded, itemsTotal) {
            console.log('Loading file:', url, itemsLoaded, 'of', itemsTotal);
        };

        // Create loader with custom error handling
        const loader = new GLTFLoader(loadingManager);
        
        // First try fetching the model to check CORS
        fetch('https://threejs.org/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                console.log('Fetch successful, loading model...');
                return loadModel();
            })
            .catch(error => {
                console.error('Fetch error:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        Error: ${error.message}. CORS might be blocking access.
                    </div>
                `;
            });

        function loadModel() {
            loader.load(
                'https://threejs.org/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf',
                function(gltf) {
                    console.log('Model loaded successfully');
                    const model = gltf.scene;
                    scene.add(model);

                    // Center camera on model
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    
                    // Adjust camera position based on model size
                    const maxDim = Math.max(size.x, size.y, size.z);
                    camera.position.z = maxDim * 2;
                    
                    // Center model
                    model.position.x = -center.x;
                    model.position.y = -center.y;
                    model.position.z = -center.z;

                    // Hide loading message
                    document.getElementById('loading').style.display = 'none';

                    // Start animation
                    animate();
                },
                function(xhr) {
                    // Progress callback
                    const percent = (xhr.loaded / xhr.total * 100).toFixed(1);
                    document.getElementById('loading').innerHTML = `
                        <div class="text-blue-600">
                            Loading: ${percent}%
                        </div>
                    `;
                },
                function(error) {
                    console.error('GLTFLoader error:', error);
                    document.getElementById('loading').innerHTML = `
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                            Error loading model: ${error.message}
                        </div>
                    `;
                }
            );
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // Handle window resize
        window.addEventListener('resize', onWindowResize, false);

        function onWindowResize() {
            camera.aspect = viewerDiv.clientWidth / viewerDiv.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(viewerDiv.clientWidth, viewerDiv.clientHeight);
        }
    </script>
</body>
</html>
